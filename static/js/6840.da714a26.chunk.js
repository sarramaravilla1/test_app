"use strict";(self.webpackChunktest_app=self.webpackChunktest_app||[]).push([[2629,6840,8988],{6840:(e,t,r)=>{r.r(t),r.d(t,{CIMSymbolRasterizer:()=>p});var i=r(19902),s=r(30050),a=r(94110),o=r(401),n=r(48988),l=r(83367),c=r(97763);const h=96/72;class p{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new s.A}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,r,s,a,h,p,u,d,m){if(!e)return null;const{data:y}=e;if(!y||"CIMSymbolReference"!==y.type||!y.symbol)return null;const{symbol:g}=y;h||(h=(0,c.n5)(g));const v=await n.OverrideHelper.resolveSymbolOverrides(y,t,this._spatialReference,a,h,p,u),M=this._cimResourceManager,w=[];o.wp.fetchResources(v,M,w),o.wp.fetchFonts(v,M,w),w.length>0&&await Promise.all(w);const{width:b,height:C}=r;let x=f(h,b,C,s,m);const I=o.wp.getEnvelope(v,x,M);if(!I)return null;I.x===1/0&&(I.x=b+2),I.y===1/0&&(I.y=-C/2),I.width===-1/0&&(I.width=b),I.height===-1/0&&(I.height=C);let S=1,k=0,O=0;switch(g.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;I.width>b&&(e=b/I.width);let t=1;I.height>C&&(t=C/I.height),"preview"===s&&(I.width<b&&(e=b/I.width),I.height<C&&(t=C/I.height)),S=Math.min(e,t),k=I.x+I.width/2,O=I.y+I.height/2}break;case"CIMLineSymbol":if(m){O=I.y+I.height/2,k=I.x+I.width/2;const e=I.width-b,t=I.height-C;x={paths:(0,l.hs)(x.paths,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{(d||I.height>C)&&(S=C/I.height),O=I.y+I.height/2;const e=I.x*S+b/2,t=(I.x+I.width)*S+b/2,r=(0,i.Rg)(x)?x.paths:(0,i.Bi)(x)?x.rings:null;if(null===r)throw new Error("Bad geometry, can't rasterise symbol!");r[0][0][0]-=e/S,r[0][2][0]-=(t-b)/S}break;case"CIMPolygonSymbol":if(m){O=I.y+I.height/2,k=I.x+I.width/2;const e=I.width-b,t=I.height-C;x={paths:(0,l.hs)(x.rings,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{k=I.x+I.width/2,O=I.y+I.height/2;const e=I.x*S+b/2,t=(I.x+I.width)*S+b/2,r=I.y*S+C/2,i=(I.y+I.height)*S+C/2,{rings:s}=x;e<0&&(s[0][0][0]-=e,s[0][3][0]-=e,s[0][4][0]-=e),r<0&&(s[0][0][1]+=r,s[0][1][1]+=r,s[0][4][1]+=r),t>b&&(s[0][1][0]-=t-b,s[0][2][0]-=t-b),i>C&&(s[0][2][1]+=i-C,s[0][3][1]+=i-C)}}const R={type:"cim",data:{type:"CIMSymbolReference",symbol:v}};return this.rasterize(R,b,C,k,O,S,h,1,x)}rasterize(e,t,r,i,s,o,n){let l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,p=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:window.devicePixelRatio||1;const{data:d}=e;if(!d||"CIMSymbolReference"!==d.type||!d.symbol)return null;const{symbol:m}=d,y=this._canvas,g=u*h;y.width=t*g,y.height=r*g,n||(n=(0,c.n5)(m)),p||(p=f(n,t,r,"legend")),y.width+=2*l,y.height+=2*l;const v=y.getContext("2d",{willReadFrequently:!0}),M=a.IT.createIdentity();return M.translate(-i,-s),M.scale(o*g,-o*g),M.translate(t*g/2+l,r*g/2+l),v.clearRect(0,0,y.width,y.height),new a.Rj(v,this._cimResourceManager,M,!0).drawSymbol(m,p),v.getImageData(0,0,y.width,y.height)}}function f(e,t,r,i,s){const a=-t/2+1,o=t/2-1,n=r/2-1,c=-r/2+1;if(s&&("esriGeometryPolygon"===e||"esriGeometryPolyline"===e)){const i=function(e,t,r,i){return"esriGeometryPolygon"===t?{rings:(0,l.Tl)((0,l.hs)(e.rings,{xmin:0,ymin:0,width:r,height:i}),-1*r/2,-1*i/2)}:"esriGeometryPolyline"===t?{paths:(0,l.Tl)((0,l.hs)(e.paths,{xmin:0,ymin:0,width:r,height:i}),-1*r/2,-1*i/2)}:null}(s,e,t,r);if(i)return i}switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[o,0]]]};default:return"legend"===i?{rings:[[[a,n],[o,0],[o,c],[a,c],[a,n]]]}:{rings:[[[a,n],[o,n],[o,c],[a,c],[a,n]]]}}}},30050:(e,t,r)=>{r.d(t,{A:()=>a});var i=r(85504),s=r(16770);class a{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){var t;return null!==(t=this._resourceMap.get(e))&&void 0!==t?t:null}async fetchResource(e,t){const r=this._resourceMap.get(e);if(r)return{width:r.width,height:r.height};let i=this._inFlightResourceMap.get(e);return i?i.then(e=>({width:e.width,height:e.height})):(i=(0,s.M5)(e,t),this._inFlightResourceMap.set(e,i),i.then(t=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,t),{width:t.width,height:t.height}),()=>({width:0,height:0})))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return(0,i.Al)(e)}}},48988:(e,t,r)=>{r.d(t,{OverrideHelper:()=>p});var i=r(69539),s=r(59784),a=r(53084),o=r(1900),n=r(81456),l=r(97763),c=r(52629);const h=e=>{if(!e)return[0,0,0,0];const{r:t,g:r,b:i,a:s}=e;return[t,r,i,255*s]};class p{static findApplicableOverrides(e,t,r){if(e&&t){if(e.primitiveName){let i=!1;for(const t of r)if(t.primitiveName===e.primitiveName){i=!0;break}if(!i)for(const s of t)s.primitiveName===e.primitiveName&&r.push(s)}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(const i of e.effects)p.findApplicableOverrides(i,t,r);if(e.symbolLayers)for(const i of e.symbolLayers)p.findApplicableOverrides(i,t,r);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(e.effects)for(const i of e.effects)p.findApplicableOverrides(i,t,r);if(e.markerPlacement&&p.findApplicableOverrides(e.markerPlacement,t,r),"CIMVectorMarker"===e.type){if(e.markerGraphics)for(const i of e.markerGraphics)p.findApplicableOverrides(i,t,r),p.findApplicableOverrides(i.symbol,t,r)}else"CIMCharacterMarker"===e.type?p.findApplicableOverrides(e.symbol,t,r):"CIMHatchFill"===e.type?p.findApplicableOverrides(e.lineSymbol,t,r):"CIMPictureMarker"===e.type&&p.findApplicableOverrides(e.animatedSymbolProperties,t,r)}}}static findEffectOverrides(e,t){if(!e)return null;if("CIMGeometricEffectDashes"===e.type&&(0,l.FH)(e),!t||!e.primitiveName)return{type:"cim-effect-param",effect:e,overrides:[]};const r=(0,l.rB)(e),i=e.primitiveName,s=[];for(const a of t)a.primitiveName===i&&s.push((0,l.rB)(a));return{type:"cim-effect-param",effect:r,overrides:(0,l.pk)(s)}}static async resolveSymbolOverrides(e,t,r,i,s,n,c){if(null===e||void 0===e||!e.symbol)return null;let{symbol:h,primitiveOverrides:f}=e;const u=!!f;if(!u&&!i)return h;h=(0,a.o8)(h),f=(0,a.o8)(f);let d=!0;if(t||(t={attributes:{}},d=!1),u){if(d||(f=f.filter(e=>{var t;return!(null!==(t=e.valueExpressionInfo)&&void 0!==t&&t.expression.includes("$feature"))})),c||(f=f.filter(e=>{var t;return!(null!==(t=e.valueExpressionInfo)&&void 0!==t&&t.expression.includes("$view"))})),f.length>0){const e=(0,l.O2)(t.attributes),i={spatialReference:r,fields:e,geometryType:s};await p.createRenderExpressions(f,i),p.evaluateOverrides(f,t,null!==s&&void 0!==s?s:"esriGeometryPoint",n,c,new o.A(e))}p.applyOverrides(h,f)}return i&&p.applyDictionaryTextOverrides(h,t,i,null),h}static async createRenderExpressions(e,t){const r=[];for(const i of e){const e=i.valueExpressionInfo;if(!e||p._expressionToRenderExpression.has(e.expression))continue;const s=(0,n.Ad)(e.expression,t.spatialReference);r.push(s),s.then(t=>p._expressionToRenderExpression.set(e.expression,t))}r.length>0&&await Promise.all(r)}static evaluateOverrides(e,t,r,i,a,o){const n={$view:{scale:null===a||void 0===a?void 0:a.scale}};for(const l of e){l.value&&"object"==typeof l.value&&(0,s.IB)(l.value)&&("Color"===l.propertyName||"StrokeColor"===l.propertyName)&&(l.value=h(l.value));const e=l.valueExpressionInfo;if(!e)continue;const a=p._expressionToRenderExpression.get(e.expression);a&&(l.value=(0,c.default)(a,t,n,r,o,i))}}static applyDictionaryTextOverrides(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Normal";if(null!==e&&void 0!==e&&e.type)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":case"CIMTextSymbol":{const a=e.symbolLayers;if(!a)return;for(const o of a)o&&"CIMVectorMarker"===o.type&&p.applyDictionaryTextOverrides(o,t,r,i,"CIMTextSymbol"===e.type?e.textCase:s)}break;case"CIMVectorMarker":{const s=e.markerGraphics;if(!s)return;for(const e of s)e&&p.applyDictionaryTextOverrides(e,t,r,i)}break;case"CIMMarkerGraphic":{const a=e.textString;if(a&&a.includes("[")){const o=(0,l.gQ)(a,r);e.textString=(0,l.FM)(t,o,i,s)}}}}static applyOverrides(e,t,r,i){if(e.primitiveName)for(const s of t)if(s.primitiveName===e.primitiveName){const t=(0,l.YF)(s.propertyName);if(i&&i.push({cim:e,nocapPropertyName:t,value:e[t]}),r){let t=!1;for(const i of r)i.primitiveName===e.primitiveName&&(t=!0);t||r.push(s)}null!=s.value&&(e[t]=s.value)}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(const s of e.effects)p.applyOverrides(s,t,r,i);if(e.symbolLayers)for(const s of e.symbolLayers)p.applyOverrides(s,t,r,i);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(e.effects)for(const s of e.effects)p.applyOverrides(s,t,r,i);if("CIMVectorMarker"===e.type&&e.markerGraphics)for(const s of e.markerGraphics)p.applyOverrides(s,t,r,i),p.applyOverrides(s.symbol,t,r,i)}}static restoreOverrides(e){for(const t of e)t.cim[t.nocapPropertyName]=t.value}static buildOverrideKey(e){let t="";for(const r of e)void 0!==r.value&&(t+="".concat(r.primitiveName).concat(r.propertyName).concat(JSON.stringify(r.value)));return t}static toValue(e,t){if("DashTemplate"===e)return t.split(" ").map(e=>Number(e));if("Color"===e){const e=new i.A(t).toRgba();return e[3]*=255,e}return t}}p._expressionToRenderExpression=new Map},52629:(e,t,r)=>{r.d(t,{default:()=>n});var i=r(89379),s=r(50076),a=r(76460),o=r(76279);function n(e,t,r,i,s,o){if(null==e)return null;const n=e.references("geometry")&&o?c(t,i,o):t,l=e.repurposeFeature(n,s);try{return e.evaluate(l,r)}catch(h){return a.A.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",h),null}}const l=new Map;function c(e,t,r){const{transform:n,hasZ:c,hasM:h}=r;l.has(t)||l.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,r,i,s)=>(0,o.Tr)(r,t,e,i,s);case"esriGeometryPolygon":return(e,r,i,s)=>(0,o.$X)(r,t,e,i,s);case"esriGeometryPolyline":return(e,r,i,s)=>(0,o.P5)(r,t,e,i,s);case"esriGeometryMultipoint":return(e,r,i,s)=>(0,o.SW)(r,t,e,i,s);default:return a.A.getLogger("esri.views.2d.support.arcadeOnDemand").error(new s.A("mapview-arcade","Unable to handle geometryType: ".concat(e))),e=>e}}(t));const p=l.get(t)(e.geometry,n,c,h);return(0,i.A)((0,i.A)({},e),{},{geometry:p})}}}]);
//# sourceMappingURL=6840.da714a26.chunk.js.map